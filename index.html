<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>奧兒絲朵 | 靈石命定測驗</title>
    <meta name="description" content="輸入國曆生日，自動換算農曆，尋找屬於您的靈魂守護石。">
    
    <!-- Tailwind CSS & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 農曆轉換庫 -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Sans:wght@300;400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans', 'Noto Sans TC', sans-serif; 
            background-color: #FAF9F6; 
            color: #44403c; 
        }
        
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .slide-up { animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

        /* 自定義選單樣式 */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }

        .stone-card {
            transition: all 0.5s ease;
        }
        .stone-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Modal 動畫 */
        .modal-enter { animation: modalIn 0.3s ease-out forwards; }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translate(-50%, -50%); }
            to { opacity: 1; transform: scale(1) translate(-50%, -50%); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center py-12 px-4 sm:px-6 lg:px-8 relative">

    <!-- 語言切換按鈕 -->
    <div class="absolute top-6 right-6 z-50">
        <button onclick="toggleLanguage()" class="flex items-center space-x-2 text-xs font-bold tracking-widest text-stone-500 hover:text-stone-800 transition uppercase border border-stone-200 px-3 py-1.5 rounded-full bg-white shadow-sm">
            <i data-lucide="globe" class="w-3 h-3"></i>
            <span id="langLabel">English</span>
        </button>
    </div>

    <!-- 頂部 Logo -->
    <div class="absolute top-6 left-0 w-full text-center fade-in pointer-events-none">
        <a href="index.html" class="pointer-events-auto text-lg font-bold tracking-[0.3em] text-stone-900 uppercase hover:text-stone-600 transition">奧兒絲朵</a>
        <p class="text-[10px] tracking-[0.2em] text-stone-400 mt-2">SOUL STONE CALCULATOR</p>
    </div>

    <!-- 主要測驗區塊 -->
    <main class="w-full max-w-md space-y-8 bg-white p-8 md:p-12 rounded-2xl shadow-xl border border-stone-100 slide-up" style="animation-delay: 0.2s;">
        
        <div class="text-center">
            <div class="mx-auto h-16 w-16 bg-stone-50 rounded-full flex items-center justify-center mb-4">
                <i data-lucide="sun" class="h-8 w-8 text-stone-400"></i>
            </div>
            <h2 id="ui-title" class="text-2xl font-medium text-stone-800 tracking-widest mb-2">尋找您的命定靈石</h2>
            <p id="ui-desc" class="text-xs text-stone-500 tracking-wider leading-relaxed">
                輸入您的<span class="font-bold text-stone-700">國曆 (Solar)</span> 出生日期，<br>
                系統將自動換算精確的農曆五行，<br>
                為您連結那顆等待已久的守護石。
            </p>
        </div>

        <form id="calcForm" class="mt-8 space-y-6" onsubmit="calculateStone(event)">
            <div class="space-y-5">
                <!-- 年份 -->
                <div class="relative">
                    <label id="label-year" for="year" class="block text-xs font-medium text-stone-500 tracking-widest mb-1">國曆出生年</label>
                    <select id="year" required class="block w-full pl-3 pr-10 py-3 text-sm border border-stone-200 focus:outline-none focus:ring-1 focus:ring-stone-400 focus:border-stone-400 rounded-md bg-stone-50 text-stone-700">
                        <option value="" disabled selected data-i18n="select-year">請選擇年份</option>
                        <!-- JS 會自動填充年份 -->
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- 月份 -->
                    <div class="relative">
                        <label id="label-month" for="month" class="block text-xs font-medium text-stone-500 tracking-widest mb-1">國曆月份</label>
                        <select id="month" required class="block w-full pl-3 pr-10 py-3 text-sm border border-stone-200 focus:outline-none focus:ring-1 focus:ring-stone-400 focus:border-stone-400 rounded-md bg-stone-50 text-stone-700">
                            <option value="" disabled selected data-i18n="select-month">月份</option>
                            <!-- JS 會自動填充月份 -->
                        </select>
                    </div>
                    <!-- 日期 -->
                    <div class="relative">
                        <label id="label-day" for="day" class="block text-xs font-medium text-stone-500 tracking-widest mb-1">國曆日期</label>
                        <select id="day" required class="block w-full pl-3 pr-10 py-3 text-sm border border-stone-200 focus:outline-none focus:ring-1 focus:ring-stone-400 focus:border-stone-400 rounded-md bg-stone-50 text-stone-700">
                            <option value="" disabled selected data-i18n="select-day">日期</option>
                            <!-- JS 會自動填充日期 -->
                        </select>
                    </div>
                </div>
            </div>

            <div class="pt-4">
                <button type="submit" class="group relative w-full flex justify-center py-4 px-4 border border-transparent text-sm font-bold rounded-md text-white bg-stone-800 hover:bg-stone-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stone-500 transition-all tracking-[0.2em] uppercase shadow-lg">
                    <span id="btn-calc">開始轉換並感應</span>
                    <span class="absolute right-0 inset-y-0 flex items-center pr-3">
                        <i data-lucide="arrow-right" class="h-4 w-4 text-stone-400 group-hover:text-white transition"></i>
                    </span>
                </button>
            </div>
        </form>

        <!-- 結果展示區 (預設隱藏) -->
        <div id="resultArea" class="hidden text-center space-y-6 pt-6 border-t border-stone-100">
            <div id="loading-text" class="animate-pulse text-stone-400 text-xs tracking-widest mb-4">正在換算農曆五行...</div>
        </div>

    </main>
    
    <!-- 聯絡專員 Modal (預設隱藏) -->
    <div id="contactModal" class="fixed inset-0 z-[100] hidden">
        <!-- 背景遮罩 -->
        <div class="absolute inset-0 bg-stone-900/60 backdrop-blur-sm transition-opacity" onclick="closeContactModal()"></div>
        
        <!-- 表單視窗 -->
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm rounded-2xl p-8 shadow-2xl modal-enter">
            <div class="text-center mb-6">
                <h3 id="modal-title" class="text-xl font-bold text-stone-800 tracking-widest mb-2">專員購藏協助</h3>
                <p id="modal-desc" class="text-xs text-stone-500 leading-relaxed">
                    請留下您的資訊，專員將為您介紹現貨款式與購買流程。<br>
                    <span class="text-stone-400 font-light block mt-1">(此服務專注於協助購買挑選，非命理諮詢)</span>
                </p>
            </div>
            
            <form id="contactForm" onsubmit="handleContactSubmit(event)" class="space-y-4">
                <div>
                    <label id="label-cName" for="cName" class="block text-xs font-medium text-stone-500 mb-1">您的稱呼</label>
                    <input type="text" id="cName" required class="w-full px-3 py-2 border border-stone-200 rounded-md text-sm focus:outline-none focus:border-stone-400 bg-stone-50" placeholder="Name">
                </div>
                <div>
                    <label id="label-cContact" for="cContact" class="block text-xs font-medium text-stone-500 mb-1">聯絡方式 (手機 / LINE ID)</label>
                    <input type="text" id="cContact" required class="w-full px-3 py-2 border border-stone-200 rounded-md text-sm focus:outline-none focus:border-stone-400 bg-stone-50" placeholder="Contact Info">
                </div>
                
                <button id="btn-submit" type="submit" class="w-full py-3 bg-stone-800 text-white text-xs font-bold tracking-[0.2em] uppercase rounded hover:bg-stone-700 transition mt-2">
                    確認送出
                </button>
            </form>
            
            <button onclick="closeContactModal()" class="absolute top-4 right-4 text-stone-400 hover:text-stone-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- 頁腳版權 -->
    <footer class="mt-12 text-center text-[10px] text-stone-300 tracking-[0.2em]">
        &copy; 2025 OUR STORY. ALL RIGHTS RESERVED.
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, initializeFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDruZNMUyiJNcyoksYIBDHv5F1SiiG2Mss",
            authDomain: "our-story-53723.firebaseapp.com",
            projectId: "our-story-53723",
            storageBucket: "our-story-53723.firebasestorage.app",
            messagingSenderId: "651350028652",
            appId: "1:651350028652:web:44db9f6bd7d1b502578349"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });

        // 登入以讀取資料
        signInAnonymously(auth).catch(() => {});

        // 監聽後台圖片設定 (自動更新圖片)
        onSnapshot(doc(db, 'artifacts', 'our-story-53723', 'public', 'data', 'siteSettings', 'calculator'), (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                if (data.stones) {
                    // 更新本地 STONES 物件中的圖片
                    Object.keys(data.stones).forEach(key => {
                        if (STONES[key] && data.stones[key]) {
                            STONES[key].img = data.stones[key];
                        }
                    });
                    
                    // 如果目前正在顯示結果，嘗試刷新圖片 (如果不影響使用者體驗)
                    const resultImg = document.querySelector('#resultArea img');
                    if(resultImg) {
                        // 簡單重整邏輯，這裡可以根據需要做得更細緻
                        const currentStoneName = document.querySelector('#resultArea h3')?.innerText;
                        // 略過複雜 DOM 操作，等待下次計算即可
                    }
                }
            }
        });

        // 導出全局變數供 HTML onclick 使用
        window.toggleLanguage = toggleLanguage;
        window.calculateStone = calculateStone;
        window.openContactModal = openContactModal;
        window.closeContactModal = closeContactModal;
        window.handleContactSubmit = handleContactSubmit;

        // --- 以下為原有的邏輯 (包在 module 中) ---
        
        lucide.createIcons();
        let currentLang = 'zh';

        const I18N = {
            zh: {
                title: "尋找您的命定靈石",
                desc: `輸入您的<span class="font-bold text-stone-700">國曆 (Solar)</span> 出生日期，<br>系統將自動換算精確的農曆五行，<br>為您連結那顆等待已久的守護石。`,
                labelYear: "國曆出生年",
                labelMonth: "國曆月份",
                labelDay: "國曆日期",
                btnCalc: "開始轉換並感應",
                loading: "正在換算農曆五行...",
                resultTitle: "農曆出生資訊",
                btnCollection: "查看收藏系列",
                btnBuy: "洽詢專員購買",
                btnRetry: "重新測驗",
                modalTitle: "專員購藏協助",
                modalDesc: `請留下您的資訊，專員將為您介紹現貨款式與購買流程。<br><span class="text-stone-400 font-light block mt-1">(此服務專注於協助購買挑選，非命理諮詢)</span>`,
                labelCName: "您的稱呼",
                labelCContact: "聯絡方式 (手機 / LINE ID)",
                btnSubmit: "確認送出",
                alertSent: "資料已送出！稍後將有專員與您聯繫。",
                sending: "資料傳送中...",
                selectYear: "請選擇年份",
                selectMonth: "月份",
                selectDay: "日期",
                yearSuffix: "年",
                monthSuffix: "月",
                daySuffix: "日",
                refImg: "示意圖"
            },
            en: {
                title: "Find Your Destined Stone",
                desc: `Enter your <span class="font-bold text-stone-700">Solar Birth Date</span>.<br>We will calculate your Lunar Elemental Energy<br>to reveal your Guardian Stone.`,
                labelYear: "Birth Year (Solar)",
                labelMonth: "Birth Month",
                labelDay: "Birth Day",
                btnCalc: "Reveal My Stone",
                loading: "Calculating Cosmic Energy...",
                resultTitle: "Your Lunar Profile",
                btnCollection: "View Collection",
                btnBuy: "Contact for Purchase",
                btnRetry: "Retake Quiz",
                modalTitle: "Purchasing Assistance",
                modalDesc: `Leave your info, and a specialist will guide you through our collection.<br><span class="text-stone-400 font-light block mt-1">(Assistance for purchase, not fortune telling)</span>`,
                labelCName: "Your Name",
                labelCContact: "Contact (Phone / LINE / WhatsApp)",
                btnSubmit: "Submit",
                alertSent: "Sent! A specialist will contact you shortly.",
                sending: "Sending...",
                selectYear: "Select Year",
                selectMonth: "Month",
                selectDay: "Day",
                yearSuffix: "",
                monthSuffix: "",
                daySuffix: "",
                refImg: "Reference"
            }
        };

        const MONTH_EN = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        const STONES = {
            moldavite: {
                name: { zh: "捷克隕石", en: "Moldavite" },
                desc: { 
                    zh: "來自外太空的綠色奇蹟。擁有極高的振動頻率，能打通心輪，加速願望顯化，帶領您突破現狀，迎接靈魂的蛻變。",
                    en: "The green miracle from outer space. With extremely high vibration, it opens the Heart Chakra, accelerates manifestation, and guides you through spiritual transformation."
                },
                tags: { zh: ["#轉化", "#心輪", "#招財"], en: ["#Transformation", "#HeartChakra", "#Abundance"] },
                img: "https://images.unsplash.com/photo-1617791160588-241658c0f566?auto=format&fit=crop&q=80&w=600", 
                color: "text-green-700"
            },
            libyan: {
                name: { zh: "利比亞隕石", en: "Libyan Desert Glass" },
                desc: {
                    zh: "沙漠中的黃金之光。擁有強大的太陽能量，能增強意志力與自信，像沙漠中的烈日一樣驅散陰霾，帶來豐盛與守護。",
                    en: "Golden light of the desert. Possessing powerful solar energy, it strengthens will and confidence, dispelling shadows like the desert sun to bring protection."
                },
                tags: { zh: ["#意志力", "#太陽輪", "#顯化"], en: ["#Willpower", "#SolarPlexus", "#Manifestation"] },
                img: "https://images.unsplash.com/photo-1610421272714-b15392e2764f?auto=format&fit=crop&q=80&w=600", 
                color: "text-yellow-600"
            },
            tektite: {
                name: { zh: "黑隕石", en: "Black Tektite" },
                desc: {
                    zh: "最強大的防禦之盾。具有深厚的接地能量，能排除負能量、濁氣，為您建立強大的能量場，讓身心回歸穩定的平靜。",
                    en: "The ultimate shield. With deep grounding energy, it repels negativity and cleanses the aura, establishing a powerful protective field for inner peace."
                },
                tags: { zh: ["#避邪", "#海底輪", "#接地"], en: ["#Protection", "#RootChakra", "#Grounding"] },
                img: "https://images.unsplash.com/photo-1596500954004-9a3d46cb0531?auto=format&fit=crop&q=80&w=600", 
                color: "text-stone-800"
            },
            gibeon: {
                name: { zh: "天鐵", en: "Gibeon Meteorite" },
                desc: {
                    zh: "宇宙力量的具象化。其獨特的維德曼交角紋路是強大能量的證明，能打通七脈輪，提升整體氣場，賦予您果斷的行動力。",
                    en: "Cosmic power embodied. Its unique Widmanstätten pattern proves its immense energy, aligning all chakras, boosting aura, and empowering decisive action."
                },
                tags: { zh: ["#能量", "#氣場", "#行動力"], en: ["#Energy", "#Aura", "#Action"] },
                img: "https://images.unsplash.com/photo-1629804268393-3d0271701388?auto=format&fit=crop&q=80&w=600", 
                color: "text-slate-500"
            },
            pallasite: {
                name: { zh: "橄欖隕石", en: "Pallasite" },
                desc: {
                    zh: "天鐵與橄欖石的完美結合。象徵宇宙的幸運與富足，金黃色的光芒能帶來意想不到的好運，是尊貴與財富的象徵。",
                    en: "A perfect fusion of iron and olivine. Symbolizing cosmic luck and abundance, its golden glow attracts unexpected fortune, representing nobility and wealth."
                },
                tags: { zh: ["#幸運", "#財富", "#貴人"], en: ["#Luck", "#Wealth", "#Nobility"] },
                img: "https://images.unsplash.com/photo-1602117565819-d91d1e449208?auto=format&fit=crop&q=80&w=600",
                color: "text-yellow-700"
            },
            cherryAgate: {
                name: { zh: "櫻花瑪瑙", en: "Cherry Blossom Agate" },
                desc: {
                    zh: "溫柔綻放的生命之花。每一朵櫻花都是時間的凝結，能滋養心靈，提升人緣與魅力，讓您在忙碌中也能保有一份優雅與從容。",
                    en: "Flowers of life gently blooming. Each blossom nurtures the soul, enhancing charm and relationships, keeping you elegant and composed amidst busyness."
                },
                tags: { zh: ["#人緣", "#溫柔", "#療癒"], en: ["#Relationships", "#Gentleness", "#Healing"] },
                img: "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?auto=format&fit=crop&q=80&w=600", 
                color: "text-pink-400"
            }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            document.getElementById('langLabel').innerText = currentLang === 'zh' ? 'English' : '中文';
            updateUI();
            populateDropdowns(); 
        }

        function updateUI() {
            const t = I18N[currentLang];
            const safeSetText = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
            const safeSetHTML = (id, val) => { const el = document.getElementById(id); if (el) el.innerHTML = val; };

            safeSetText('ui-title', t.title);
            safeSetHTML('ui-desc', t.desc);
            safeSetText('label-year', t.labelYear);
            safeSetText('label-month', t.labelMonth);
            safeSetText('label-day', t.labelDay);
            safeSetText('btn-calc', t.btnCalc);
            const loadingEl = document.getElementById('loading-text');
            if (loadingEl) loadingEl.innerText = t.loading;
            
            safeSetText('modal-title', t.modalTitle);
            safeSetHTML('modal-desc', t.modalDesc);
            safeSetText('label-cName', t.labelCName);
            safeSetText('label-cContact', t.labelCContact);
            safeSetText('btn-submit', t.btnSubmit);
            
            const resultArea = document.getElementById('resultArea');
            if (resultArea && !resultArea.classList.contains('hidden')) {
                if(document.getElementById('year').value) {
                    calculateStone(); 
                }
            }
        }

        function populateDropdowns() {
            const yearSelect = document.getElementById('year');
            const monthSelect = document.getElementById('month');
            const daySelect = document.getElementById('day');
            const valY = yearSelect.value;
            const valM = monthSelect.value;
            const valD = daySelect.value;
            
            yearSelect.innerHTML = `<option value="" disabled selected>${I18N[currentLang].selectYear}</option>`;
            monthSelect.innerHTML = `<option value="" disabled selected>${I18N[currentLang].selectMonth}</option>`;
            daySelect.innerHTML = `<option value="" disabled selected>${I18N[currentLang].selectDay}</option>`;

            for (let i = 2025; i >= 1950; i--) {
                let option = document.createElement('option');
                option.value = i;
                option.text = currentLang === 'zh' ? `西元 ${i} 年` : `${i}`;
                yearSelect.appendChild(option);
            }
            for (let i = 1; i <= 12; i++) {
                let option = document.createElement('option');
                option.value = i;
                option.text = currentLang === 'zh' ? `${i}月` : MONTH_EN[i-1];
                monthSelect.appendChild(option);
            }
            for (let i = 1; i <= 31; i++) {
                let option = document.createElement('option');
                option.value = i;
                option.text = currentLang === 'zh' ? `${i}日` : `${i}`;
                daySelect.appendChild(option);
            }
            if(valY) yearSelect.value = valY;
            if(valM) monthSelect.value = valM;
            if(valD) daySelect.value = valD;
        }

        function calculateStone(e) {
            if (e) e.preventDefault();
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);
            const day = parseInt(document.getElementById('day').value);
            
            if(!year || !month || !day) return;

            const resultArea = document.getElementById('resultArea');
            resultArea.classList.remove('hidden');
            
            if (e) {
                resultArea.innerHTML = `<div class="flex justify-center items-center py-10"><i data-lucide="loader-2" class="animate-spin h-8 w-8 text-stone-400"></i></div>`;
                lucide.createIcons();
            }

            const delay = e ? 1000 : 0;

            setTimeout(() => {
                const solar = Solar.fromYmd(year, month, day);
                const lunar = solar.getLunar();
                const lunarYear = lunar.getYear();
                const lunarMonth = lunar.getMonth();
                
                let dateDisplay = "";
                if (currentLang === 'zh') {
                    const ganZhiYear = lunar.getYearInGanZhi(); 
                    const zodiac = toTraditionalChinese(lunar.getYearShengXiao()); 
                    const lunarMonthChi = toTraditionalChinese(lunar.getMonthInChinese()); 
                    const lunarDayChi = lunar.getDayInChinese(); 
                    dateDisplay = `${ganZhiYear}年 (${zodiac}) ${lunarMonthChi}月 ${lunarDayChi}`;
                } else {
                    const zodiacEn = getZodiacEn(lunar.getYearShengXiao());
                    dateDisplay = `Lunar Year ${lunarYear} (${zodiacEn}) - Month ${lunarMonth}, Day ${lunar.getDay()}`;
                }

                const stoneKey = getStoneByFate(lunarYear, lunarMonth);
                const stone = STONES[stoneKey];
                
                renderResult(stone, dateDisplay);
            }, delay);
        }
        
        function getZodiacEn(chiZodiac) {
            const map = {
                '鼠': 'Rat', '牛': 'Ox', '虎': 'Tiger', '兔': 'Rabbit',
                '龙': 'Dragon', '蛇': 'Snake', '马': 'Horse', '羊': 'Goat',
                '猴': 'Monkey', '鸡': 'Rooster', '狗': 'Dog', '豬': 'Pig',
                '龍': 'Dragon', '馬': 'Horse', '雞': 'Rooster', '豬': 'Pig'
            };
            return map[chiZodiac] || chiZodiac;
        }

        function toTraditionalChinese(str) {
            const map = { '龙': '龍', '马': '馬', '鸡': '雞', '猪': '豬', '腊': '臘' };
            return str.split('').map(char => map[char] || char).join('');
        }

        function getStoneByFate(lunarYear, lunarMonth) {
            const lastDigit = lunarYear % 10;
            if (lastDigit === 0 || lastDigit === 1) { 
                if (lunarMonth >= 10 || lunarMonth <= 12) return 'gibeon'; 
                if (lunarMonth >= 4 && lunarMonth <= 6) return 'tektite'; 
                return 'gibeon'; 
            }
            if (lastDigit === 2 || lastDigit === 3) { 
                if (lunarMonth >= 1 && lunarMonth <= 3) return 'gibeon';
                return 'moldavite'; 
            }
            if (lastDigit === 4 || lastDigit === 5) { 
                if (lunarMonth >= 7 && lunarMonth <= 9) return 'tektite'; 
                return 'moldavite'; 
            }
            if (lastDigit === 6 || lastDigit === 7) { 
                if (lunarMonth >= 10 || lunarMonth <= 12) return 'cherryAgate'; 
                if (lunarMonth >= 4 && lunarMonth <= 6) return 'libyan'; 
                return 'cherryAgate'; 
            }
            if (lastDigit === 8 || lastDigit === 9) { 
                if (lunarMonth >= 1 && lunarMonth <= 3) return 'libyan'; 
                return 'pallasite'; 
            }
            return 'gibeon';
        }

        function renderResult(stone, dateDisplay) {
            const t = I18N[currentLang];
            const name = stone.name[currentLang];
            const desc = stone.desc[currentLang];
            const tags = stone.tags[currentLang];
            const subTitle = currentLang === 'zh' ? stone.name.en : ""; 

            const html = `
                <div class="stone-card bg-stone-50 rounded-xl overflow-hidden shadow-sm border border-stone-100 fade-in">
                    <div class="bg-stone-100 p-4 border-b border-stone-200 text-center">
                        <p class="text-[10px] text-stone-400 tracking-wider mb-1 uppercase">${t.resultTitle}</p>
                        <p class="text-sm font-bold text-stone-700 tracking-widest">${dateDisplay}</p>
                    </div>

                    <div class="relative h-64 overflow-hidden bg-stone-200 group">
                        <img src="${stone.img}" 
                             alt="${name}" 
                             class="w-full h-full object-cover"
                             onerror="this.onerror=null; this.src='https://placehold.co/600x400/e7e5e4/57534e?text=${stone.name.en}';">
                        <div class="absolute top-2 right-2 bg-black/30 text-white text-[9px] px-2 py-1 rounded backdrop-blur-sm tracking-wider">
                            ${t.refImg}
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-stone-900/60 to-transparent flex items-end justify-center pb-6">
                            <h3 class="text-white text-2xl font-bold tracking-[0.2em]">${name}</h3>
                        </div>
                    </div>
                    <div class="p-8">
                        ${subTitle ? `<p class="text-xs text-stone-400 uppercase tracking-widest mb-4 font-bold">${subTitle}</p>` : ''}
                        <p class="text-sm text-stone-600 leading-loose tracking-wide mb-6 text-justify">
                            ${desc}
                        </p>
                        <div class="flex justify-center space-x-2 mb-8 flex-wrap gap-y-2">
                            ${tags.map(tag => `<span class="px-3 py-1 bg-white border border-stone-200 rounded-full text-[10px] text-stone-500 tracking-wider">${tag}</span>`).join('')}
                        </div>
                        
                        <div class="space-y-3">
                            <a href="index.html#collections" class="block w-full py-3 bg-stone-800 text-white text-xs font-bold tracking-[0.2em] uppercase rounded hover:bg-stone-600 transition text-center">
                                ${t.btnCollection}
                            </a>
                            <button onclick="openContactModal()" class="block w-full py-3 bg-white border border-stone-200 text-stone-600 text-xs font-bold tracking-[0.2em] uppercase rounded hover:bg-stone-50 hover:border-stone-400 transition text-center">
                                ${t.btnBuy}
                            </button>
                        </div>

                        <button onclick="resetForm()" class="mt-6 text-[10px] text-stone-400 border-b border-transparent hover:border-stone-400 hover:text-stone-600 transition">${t.btnRetry}</button>
                    </div>
                </div>
            `;
            document.getElementById('resultArea').innerHTML = html;
        }

        function resetForm() {
            document.getElementById('calcForm').reset();
            document.getElementById('resultArea').classList.add('hidden');
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function openContactModal() {
            document.getElementById('contactModal').classList.remove('hidden');
        }

        function closeContactModal() {
            document.getElementById('contactModal').classList.add('hidden');
        }

        function handleContactSubmit(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            const t = I18N[currentLang];
            btn.disabled = true;
            btn.innerText = t.sending;
            setTimeout(() => {
                alert(t.alertSent);
                btn.disabled = false;
                btn.innerText = originalText;
                e.target.reset();
                closeContactModal();
            }, 1000);
        }
        
        populateDropdowns();
    </script>
</body>
</html>
